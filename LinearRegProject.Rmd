---
title: "LinearRegProject"
author: "Nan Zhang, Lichun He, Yuqi Zhang"
date: "11/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Should This Loan be Approved or Denied?

## Setup
```{r}
# Setup
library(tidyverse)
library(lubridate)
library(broom)
library(usmap)
library(ggplot2)
library(maps)
library(mapdata)
library(dplyr)
library(viridis)
library(sf)
library(plotly)

SBAnational_raw <- read.csv(file = "SBAnational.csv", header = T)
SBAnational_raw <- na.omit(SBAnational_raw)
head(SBAnational_raw, 5)
#apply(is.na(SBA_NY_raw), 2, sum)
```
## Section 1: Pre-Process

```{r}
# Choose the data after 2000
SBAnational <- SBAnational_raw %>% 
  mutate(DisbursementDate = dmy(DisbursementDate)) %>%
  filter(LowDoc %in% c("Y", "N"),
         year(DisbursementDate) >= 2000,          
         MIS_Status == "P I F" | MIS_Status == "CHGOFF",
         NewExist != 0, UrbanRural != 0)
head(SBAnational, 5)

rmSym <- function(string){
  string <- substr(string, start = 2, stop = nchar(string))
  return(string)
}
SBAnational$DisbursementGross <- 
  as.numeric(gsub(",","", rmSym(SBAnational$DisbursementGross)))
SBAnational$BalanceGross <- 
  as.numeric(gsub(",","", rmSym(SBAnational$BalanceGross)))
SBAnational$GrAppv <- as.numeric(gsub(",","", rmSym(SBAnational$GrAppv)))
SBAnational$SBA_Appv <- as.numeric(gsub(",","", rmSym(SBAnational$SBA_Appv)))

# Visualization
SBAnational_map <- SBAnational %>% 
  group_by(State) %>% 
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = CHGOFF /(CHGOFF +PIF)) %>% 
  rename("state" = "State") %>% 
    select(-CHGOFF, -PIF) 
parts <- slice(as.data.frame(SBAnational_map), 2:52)
plot_usmap(data = parts, values = "default_rate",regions = "state") +
  scale_fill_continuous(low = "white", high = "red", 
                        name = "default rate", label = scales::comma) + 
  labs(title = "State default rate") +
  theme(legend.position = "right")

# Choose the data in NY
SBA_NY <- SBAnational %>% filter(State =="NY")
head(SBA_NY, 5)
```


## Section 2: Explore the Variables
### Section 2.1
```{r}
SBA_NY_NAICS <- SBA_NY %>%
  mutate(Industy_code = as.numeric(substr(as.character(SBA_NY$NAICS), 
                                       start = 1, stop = 2))) %>%
  group_by(Industy_code) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_NAICS
```

From the graphs, we can see that the default rates are different in each industry, so we take NAICS into our consideration

### Section 2.2
```{r}
SBA_NY_Term <- SBA_NY %>%
  mutate(LoanTerm = case_when(Term >= 240 ~ "Long",
                              Term < 240 ~ "Short")) %>%
  group_by(LoanTerm) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_Term
```

### Section 2.3
```{r}
SBA_NY_Size <- SBA_NY %>%
  mutate(Size = case_when(NoEmp <= 100 ~ "Small",
                          NoEmp > 100 ~ "Median or large")) %>%
  group_by(Size) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_Size
```
### Section 2.4
```{r}
SBA_NY_GrossDis <- SBA_NY %>%
  group_by(MIS_Status) %>%
  mutate(Quant = case_when(DisbursementGross <= quantile(DisbursementGross, 0.25) ~ "25% quartile",
                          DisbursementGross > quantile(DisbursementGross, 0.25) & DisbursementGross <= quantile(DisbursementGross, 0.5) ~ "50% quartile",
                          DisbursementGross > quantile(DisbursementGross, 0.5) & DisbursementGross <= quantile(DisbursementGross, 0.75) ~ "75% quartile",
                          DisbursementGross > quantile(DisbursementGross, 0.75) ~ "100% quartile" )) %>%
  group_by(Quant) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_GrossDis
```

### Section 2.5
```{r}
SBA_NY_UrbanRural <- SBA_NY %>%
  filter(UrbanRural != 0) %>%
  group_by(UrbanRural) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_UrbanRural
```

### Section 2.6
```{r}
SBA_NY_NewExist <- SBA_NY %>%
  group_by(NewExist) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_NewExist
```

### Section 2.7
```{r}
SBA_NY_RevLineCr <- SBA_NY %>%
  group_by(RevLineCr) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_RevLineCr
```

### Section 2.8
```{r}
SBA_NY_LowDoc <- SBA_NY %>%
  group_by(LowDoc) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_LowDoc
```

### Section 2.9
```{r}
SBA_NY_prop <- SBA_NY %>%
  mutate(prop = SBA_Appv / GrAppv) %>%
  mutate(q25 = quantile(prop, 0.25),
         median = quantile(prop,0.5), 
         q75 = quantile(prop, 0.75)) %>% 
  mutate(propQ = case_when(prop <= q75 ~ "75% quartile",
                          prop > q75 ~ "above 75% quartile" )) %>%
  group_by(propQ) %>%
  summarize(CHGOFF = sum(MIS_Status =="CHGOFF"),
            PIF = sum(MIS_Status =="P I F"), 
            default_rate = round(CHGOFF /(CHGOFF +PIF),2))
SBA_NY_prop
```

## Section 3: Fit Linear Model
### Section 3.1: Set up final dataset
```{r}
SBA_NY_final <- SBA_NY %>%
  mutate(LoanTerm = case_when(Term >= 240 ~ 0,
                              Term < 240 ~ 1)) %>%
  mutate(Size = case_when(NoEmp <= 100 ~ 1,
                          NoEmp > 100 ~ 0)) %>%
  mutate(MIS_Status = case_when(MIS_Status == "P I F" ~ 0,
                                MIS_Status == "CHGOFF"~ 1)) %>%
  mutate(LowDoc = case_when(LowDoc == "Y" ~ 0,
                            LowDoc == "N"~ 1))
#SBA_NY_final
table(SBA_NY_final$MIS_Status)
```

### Section 3.2: Split Training-Testing data
```{r}
# ## 50% of the sample size
# sample_size <- floor(0.5 * nrow(SBA_NY_final))
# 
# ## set the seed to make partition reproducible
# set.seed(123)
# train_index <- sample(seq_len(nrow(SBA_NY_final)), size = sample_size)
# 
# SBA_NY_train <- SBA_NY_final[train_index, ]
# SBA_NY_test <- SBA_NY_final[-train_index, ]
#####################

# Use the data before 2005 as training data
train = year(SBA_NY_final$DisbursementDate) < 2005
```

### Section 3.3: Fit logistical model
```{r}
# mylog <- glm(MIS_Status ~ LoanTerm + Size + LowDoc, data = SBA_NY_train, family = "binomial")
# summary(mylog)

glm.fit <- glm(MIS_Status ~ LoanTerm + Size + LowDoc,
               data = SBA_NY_final,
               family = binomial,
               subset = train)
probs <- predict(glm.fit, 
                 newdata = SBA_NY_final[!train,], 
                 type = "response")
pred = ifelse(probs > 0.5, 1, 0)
MIS_Status.2005 = SBA_NY_final$MIS_Status[!train]
table(pred, MIS_Status.2005)
mean(pred == MIS_Status.2005)
table(SBA_NY_final$LoanTerm)
```

## Section 4: Testing/Validation

```{r}
# Decision rule would be that approve the loan if estimated probability of default <= 0.5; otherwise, deny the loan. 
# max(mylog$fitted.values)
probs <- predict(mylog, SBA_NY_test, type = "response")
pred = ifelse(probs > 0.5, 1, 0)
table(pred)
```

## Section 5: Prediction

```{r}

```

## Section 6: Conclusion
